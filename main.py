import requests
import xml.etree.ElementTree as ET
from time import sleep
import couchdb
import re
from couchdb.mapping import Document, TextField
from plyer import notification
from discord_webhook import DiscordWebhook
from apscheduler.schedulers.blocking import BlockingScheduler


class Person(Document):
    link = TextField()


def run_program():
    
    #run to server with ip_server example 56.48.212.260:4954
    #run to win ip = 127.0.0.1:5984
    couchserver = couchdb.Server('#username:password@ip_server:5984#')
    dbname = "vulner_discord"
    if dbname in couchserver:
        db = couchserver[dbname]
    else:
        db = couchserver.create(dbname)
    person = Person(link='run program')
    person.store(db)
    rss_links = []
    urls = open("rss.txt", "r").read().splitlines()
    for url in urls:
        response = requests.get(url)
        content = response.content
        tree = ET.fromstring(content)
        for items in tree.iter('item'):
            title = items.find('title').text
            strings = ['\(Authenticated\)', ' Authenticated ']
            regex = re.compile('|'.join(x for x in strings))
            authenticated_regex = regex.search(title)
            if authenticated_regex:
                continue
            links = items.find('link').text
            rss_links.append(links)
    db_link = []
    for id in db:
        db_link.append(db[id]['link'])
    for rss_link in rss_links:
        if not rss_link in db_link:
            person = Person(link=rss_link)
            person.store(db)
            webhook = DiscordWebhook(url='#discord_webhook#', content=rss_link)
            webhook.execute()
            sleep(2)


scheduler = BlockingScheduler()
scheduler.add_job(run_program, 'interval', hours=6)
scheduler.start()

